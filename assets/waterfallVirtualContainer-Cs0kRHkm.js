import{t as j,a as P,d as Q}from"./utils-n8qi3FsM.js";import{d as B,a as I,r as x,z as h,j as M,n as V,I as T,J,c as _,b as L,K as F,F as K,H as X,O as W,o as f,L as Y,N as Z,G as ee,w as te}from"./index-XMpUS58h.js";import{_ as D}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{d as ae}from"./water-fall-Dqt5XexZ.js";const ne={class:"waterfall-virtual-container","element-loading-text":"拼命加载中...","element-loading-background":"rgba(255, 255, 255, 0.8)"},se=B({__name:"WaterFallVirtual",props:{column:{default:4},columnItemCount:{default:6},requestSize:{default:0},gap:{default:20},request:{type:Function,default:async()=>({list:[],total:0})}},emits:["finishGetList"],setup(q,{emit:d}){const s=q,g=d,c=I(),o=x({loading:!1,isFinish:!1,currentPage:1,total:0,list:[]}),r=x({queue:Array(s.column).fill(0).map(()=>({list:[],height:0})),len:0}),i=x({viewWidth:0,viewHeight:0,start:0,get end(){return this.start+this.viewHeight}}),w=h(()=>({height:`${y.value.maxHeight}px`})),p=h(()=>r.queue.reduce((e,{list:t})=>e.concat(t),[])),v=h(()=>p.value.filter(e=>e.h+e.y>i.start&&e.y<i.end)),y=h(()=>{let e=0,t=0,a=1/0,n=-1/0;return r.queue.forEach(({height:l},u)=>{l<a&&(a=l,e=u),l>n&&(n=l,t=u)}),{minIndex:e,maxIndex:t,minHeight:a,maxHeight:n}}),A=h(()=>o.list.reduce((e,t)=>{const a=Math.floor((i.viewWidth-(s.column-1)*s.gap)/s.column);return e.set(t.id,{width:a,height:Math.floor(a*t.height/t.width)}),e},new Map)),z=h(()=>s.requestSize||s.column*s.columnItemCount),H=h(()=>r.len<o.list.length),b=async()=>{if(o.isFinish)return;o.loading=!0,await Q();const{list:e,total:t}=await s.request(o.currentPage++,z.value);if(!e.length){o.isFinish=!0,g("finishGetList");return}o.list.push(...W(e)),o.total=t,o.loading=!1},S=(e=s.column)=>{for(let t=0;t<e;t++){if(!H.value)return;const a=y.value.minIndex,n=r.queue[a],l=n.list[n.list.length-1]||null,u=o.list[r.len],m=C(u,l,a);n.list.push(m),n.height+=m.h,r.len++}},C=(e,t,a)=>{const n=A.value.get(e.id),l=(n==null?void 0:n.width)||0,u=(n==null?void 0:n.height)||0;let m=0;return t&&(m=t.y+t.h+s.gap),W({item:e,y:m,h:u,style:{width:`${l}px`,height:`${u}px`,transform:`translate3d(${a===0?0:(l+s.gap)*a}px, ${m}px, 0)`}})},G=()=>{r.queue=r.queue.map((e,t)=>{let a=0;const n=e.list.reduce((l,{item:u},m)=>{const U=l[m-1]||null,E=C(u,U,t);return a+=E.h,l.push(E),l},[]);return{height:a,list:n}})},k=j(()=>{const{scrollTop:e,clientHeight:t}=c.value;if(i.start=e,!o.loading&&!H.value){b().then(()=>{S()});return}e+t>y.value.minHeight&&S()}),R=P(()=>{$(),G()},300),$=()=>{var e,t,a;i.viewWidth=((e=c.value)==null?void 0:e.clientWidth)||0,i.viewHeight=((t=c.value)==null?void 0:t.clientHeight)||0,i.start=((a=c.value)==null?void 0:a.scrollTop)||0},N=async()=>{var e;$(),await b(),S(z.value),(e=c.value)==null||e.addEventListener("scroll",k),window.addEventListener("resize",R)},O=()=>{var e;(e=c.value)==null||e.removeEventListener("scroll",k),window.removeEventListener("resize",R)};return M(()=>{N()}),V(()=>{O()}),(e,t)=>{const a=J("loading");return T((f(),_("div",ne,[L("div",{class:"waterfall-virtual-content",ref_key:"contentRef",ref:c},[L("div",{class:"waterfall-virtual-list",style:F(w.value)},[(f(!0),_(K,null,X(v.value,({item:n,style:l})=>(f(),_("div",{class:"waterfall-virtual-item",key:n.id,style:F(l)},[Y(e.$slots,"item",{item:n},void 0,!0)],4))),128))],4)],512)])),[[a,o.loading]])}}}),ie=D(se,[["__scopeId","data-v-12cd0167"]]),le={BASE_URL:"/project-practice/"},oe=["src"],re=B({__name:"waterfallVirtualContainer",setup(q){const d=I(0),s=I(null),g=new ResizeObserver(i=>{c(i[0].target.clientWidth)}),c=i=>{i>=960?d.value=6:i>=690&&i<960?d.value=5:i>=500&&i<690?d.value=4:d.value=2};M(()=>{s.value&&g.observe(s.value)}),V(()=>{s.value&&g.unobserve(s.value)});const{BASE_URL:o}=le,r=async(i,w)=>({total:6e3,list:ae.map(v=>({id:Math.random().toString(36).substring(2,9),src:o+v.url,height:v.height,width:v.width}))});return(i,w)=>(f(),_("div",{class:"waterfall-virtual-wrap",ref_key:"containerRef",ref:s},[d.value?(f(),Z(ie,{key:0,request:r,gap:15,column:d.value,"request-size":30},{item:te(({item:p})=>[L("img",{class:"test-item",src:p.src},null,8,oe)]),_:1},8,["column"])):ee("",!0)],512))}}),he=D(re,[["__scopeId","data-v-a184b923"]]);export{he as default};
